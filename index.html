<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="data:,">

  <title>Rust Chat Client</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }

    #log {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-bottom: 1px solid #444;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      background: #222;
      gap: 10px;
    }

    #msgInput {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      background: #333;
      border: 1px solid #555;
      color: #eee;
    }

    #sendBtn {
      padding: 10px 20px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }

    #sendBtn:hover {
      background: #45a049;
    }

    #status {
      padding: 8px;
      font-size: 14px;
      background: #222;
      border-bottom: 1px solid #444;
    }
  </style>
</head>

<body>

  <div id="status">Connecting…</div>
  <div id="log"></div>

  <div id="inputArea">
    <input id="msgInput" placeholder="Type a message or /command" />
    <button id="sendBtn">Send</button>
  </div>

  <script src="/ws_config.js"></script>
  <script>
    // WS_URL: prefer `window.__WS_URL` if provided by `ws_config.js` (generated by start_tunnels.sh)
    // Otherwise choose same-origin protocol (wss for https, ws for http).
    // This makes the client work locally and when served via a tunnel without editing this file.
    const WS_URL = (typeof window !== 'undefined' && window.__WS_URL) ? window.__WS_URL : ((location.protocol === "https:" ? "wss:" : "ws:") + "//" + location.host + "/ws");

    const logElem = document.getElementById("log");
    const msgInput = document.getElementById("msgInput");
    const status = document.getElementById("status");

    function log(msg) {
      logElem.textContent += msg + "\n";
      logElem.scrollTop = logElem.scrollHeight;
    }

    const ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      status.textContent = "Connected ✔️";
      log("Connected to server.");
    };

    ws.onmessage = (event) => {
      // try to parse JSON messages from the server (machine-readable)
      try {
        const data = JSON.parse(event.data);
        if (data && typeof data.message === 'string' && typeof data.timestamp !== 'undefined') {
          // server timestamp is in milliseconds since epoch
          const t = new Date(data.timestamp);
          const formatted = `[${t.toISOString().replace('T', ' ').replace(/\.\d+Z$/, ' UTC')}] ${data.message}`;
          log(formatted);
          return;
        }
      } catch (e) {
        // not JSON, fall through
      }

      // fallback: display raw text
      log(event.data);
    };

    ws.onclose = () => {
      status.textContent = "Disconnected ❌";
      log("Disconnected from server.");
    };

    ws.onerror = (err) => {
      log("WebSocket error.");
      console.error(err);
    };

    document.getElementById("sendBtn").onclick = sendMessage;
    msgInput.onkeydown = (e) => {
      if (e.key === "Enter") sendMessage();
    };

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      ws.send(text);
      msgInput.value = "";
    }
  </script>

</body>

</html>